(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const Z=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),ee=(e,t,{onPreviewPicture:o,onLikeIcon:r,onDeleteCard:n})=>{const s=Z(),c=s.querySelector(".card__like-button"),S=s.querySelector(".card__control-button_type_delete"),b=s.querySelector(".card__image"),T=s.querySelector(".card__like-count");b.src=e.link,b.alt=e.name,s.querySelector(".card__title").textContent=e.name;const Q=e.owner&&e.owner._id===t,P=Array.isArray(e.likes)?e.likes:[],X=P.some(Y=>Y._id===t);return T&&(T.textContent=P.length),Q?n&&S.addEventListener("click",()=>n(s,e._id)):S.remove(),X&&c.classList.add("card__like-button_is-active"),r&&c.addEventListener("click",()=>r({cardId:e._id,isLiked:c.classList.contains("card__like-button_is-active"),likeButton:c,cardElement:s})),o&&b.addEventListener("click",()=>o({name:e.name,link:e.link})),s},$=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");p(t)}},u=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",$)},p=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",$)},te=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{p(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&p(e)})},F=(e,t,o,r)=>{const n=e.querySelector(`#${t.id}-error`);t.classList.add(r.inputErrorClass),n.textContent=o,n.classList.add(r.errorClass)},R=(e,t,o)=>{const r=e.querySelector(`#${t.id}-error`);t.classList.remove(o.inputErrorClass),r.textContent="",r.classList.remove(o.errorClass)},oe=(e,t,o)=>{!t.validity.valid&&t.validity.patternMismatch&&t.dataset.errorMessage?F(e,t,t.dataset.errorMessage,o):t.validity.valid?R(e,t,o):F(e,t,t.validationMessage,o)},re=e=>e.some(t=>!t.validity.valid),j=(e,t)=>{e.disabled=!0,e.classList.add(t.inactiveButtonClass)},ne=(e,t)=>{e.disabled=!1,e.classList.remove(t.inactiveButtonClass)},U=(e,t,o)=>{re(e)?j(t,o):ne(t,o)},se=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);U(o,r,t),o.forEach(n=>{n.addEventListener("input",()=>{oe(e,n,t),U(o,r,t)})})},g=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);o.forEach(n=>{R(e,n,t)}),j(r,t)},ce=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{se(o,e)})},ae=window.axios,D={baseURL:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"adffedb0-08b5-4034-8dfc-68265d8f44d4","Content-Type":"application/json"}},a=ae.create({baseURL:D.baseURL,headers:D.headers});a.interceptors.response.use(e=>e.data,e=>{const t=e.response?.data?.message||e.message||"Неизвестная ошибка";return console.error("API Error:",t),Promise.reject(t)});const ie=()=>a.get("/users/me"),V=()=>a.get("/cards"),le=({name:e,about:t})=>a.patch("/users/me",{name:e,about:t}),ue=e=>a.patch("/users/me/avatar",{avatar:e}),pe=({name:e,link:t})=>a.post("/cards",{name:e,link:t}),H=e=>a.delete(`/cards/${e}`),de=(e,t)=>t?a.delete(`/cards/${e}/likes`):a.put(`/cards/${e}/likes`),z=document.querySelector(".places__list"),k=document.querySelector(".popup_type_edit"),v=k.querySelector(".popup__form"),K=v.querySelector(".popup__input_type_name"),G=v.querySelector(".popup__input_type_description"),w=document.querySelector(".popup_type_new-card"),d=w.querySelector(".popup__form"),_e=d.querySelector(".popup__input_type_card-name"),me=d.querySelector(".popup__input_type_url"),x=document.querySelector(".popup_type_image"),O=x.querySelector(".popup__image"),fe=x.querySelector(".popup__caption"),ye=document.querySelector(".profile__edit-button"),ve=document.querySelector(".profile__add-button"),I=document.querySelector(".profile__title"),E=document.querySelector(".profile__description"),M=document.querySelector(".profile__image"),B=document.querySelector(".popup_type_edit-avatar"),m=B.querySelector(".popup__form"),Se=m.querySelector(".popup__input"),f=document.querySelector(".popup_type_remove-card"),h=f?f.querySelector(".popup__form"):null,he=document.querySelector(".header__logo"),y=document.querySelector(".popup_type_info"),qe=y.querySelector(".popup__title"),l=y.querySelector(".popup__info"),Le=y.querySelector(".popup__text"),N=y.querySelector(".popup__list"),Ce=document.getElementById("popup-info-definition-template"),be=document.getElementById("popup-info-user-preview-template");let A=null,q=null,L=null;const C={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};ce(C);const i=(e,t,o,r)=>{t&&(e?(t.textContent=r,t.disabled=!0):(t.textContent=o,t.disabled=!1))},W=e=>e.toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric"}),_=(e,t)=>{const o=Ce.content.querySelector(".popup__info-item").cloneNode(!0);return o.querySelector(".popup__info-term").textContent=e,o.querySelector(".popup__info-description").textContent=t,o},ge=e=>{const t=be.content.querySelector(".popup__list-item").cloneNode(!0);return t.textContent=e,t},ke=e=>{const t=new Map;return e.forEach(o=>{o.owner&&o.owner._id&&!t.has(o.owner._id)&&t.set(o.owner._id,o.owner.name)}),Array.from(t.values())},we=e=>{const t={};e.forEach(r=>{if(r.owner&&r.owner._id){const n=r.owner._id;t[n]=(t[n]||0)+1}});const o=Object.values(t);return o.length>0?Math.max(...o):0},xe=()=>{V().then(e=>{if(l.innerHTML="",N.innerHTML="",qe.textContent="Статистика пользователей",e.length===0){l.append(_("Всего карточек:","0")),u(y);return}const t=[...e].sort((s,c)=>new Date(s.createdAt)-new Date(c.createdAt)),o=t[0],r=t[t.length-1],n=ke(e);l.append(_("Всего карточек:",e.length)),l.append(_("Первая создана:",W(new Date(o.createdAt)))),l.append(_("Последняя создана:",W(new Date(r.createdAt)))),l.append(_("Всего пользователей:",n.length)),l.append(_("Максимум карточек от одного:",we(e))),Le.textContent="Все пользователи:",n.forEach(s=>{N.append(ge(s))}),u(y)}).catch(e=>{console.error("Ошибка при загрузке статистики:",e)})},Ie=({name:e,link:t})=>{O.src=t,O.alt=e,fe.textContent=e,u(x)},Ee=({cardId:e,isLiked:t,likeButton:o,cardElement:r})=>{de(e,t).then(n=>{const s=n.likes.some(S=>S._id===A),c=r.querySelector(".card__like-count");s?o.classList.add("card__like-button_is-active"):o.classList.remove("card__like-button_is-active"),c&&(c.textContent=n.likes.length)}).catch(n=>{console.error("Ошибка при изменении лайка:",n)})},Me=(e,t)=>{f&&h?(q=e,L=t,u(f)):H(t).then(()=>{e.remove()}).catch(o=>{console.error("Ошибка при удалении карточки:",o)})},J=e=>ee(e,A,{onPreviewPicture:Ie,onLikeIcon:Ee,onDeleteCard:Me}),Be=e=>{e.preventDefault();const t=v.querySelector(".popup__button"),o=t?t.textContent:"Сохранить";i(!0,t,o,"Сохранение..."),le({name:K.value,about:G.value}).then(r=>{I.textContent=r.name,E.textContent=r.about,p(k)}).catch(r=>{console.error("Ошибка при обновлении профиля:",r)}).finally(()=>{i(!1,t,o,"Сохранение...")})},Ae=e=>{e.preventDefault();const t=m.querySelector(".popup__button"),o=t?t.textContent:"Сохранить";i(!0,t,o,"Сохранение..."),ue(Se.value).then(r=>{M.style.backgroundImage=`url(${r.avatar})`,p(B),m.reset()}).catch(r=>{console.error("Ошибка при обновлении аватара:",r)}).finally(()=>{i(!1,t,o,"Сохранение...")})},Te=e=>{e.preventDefault();const t=d.querySelector(".popup__button"),o=t?t.textContent:"Создать";i(!0,t,o,"Создание..."),pe({name:_e.value,link:me.value}).then(r=>{z.prepend(J(r)),p(w),d.reset()}).catch(r=>{console.error("Ошибка при добавлении карточки:",r)}).finally(()=>{i(!1,t,o,"Создать")})};v.addEventListener("submit",Be);d.addEventListener("submit",Te);m.addEventListener("submit",Ae);he.addEventListener("click",xe);ye.addEventListener("click",()=>{K.value=I.textContent,G.value=E.textContent,u(k),g(v,C)});M.addEventListener("click",()=>{m.reset(),u(B),g(m,C)});ve.addEventListener("click",()=>{d.reset(),u(w),g(d,C)});h&&f&&h.addEventListener("submit",e=>{if(e.preventDefault(),!q||!L)return;const t=h.querySelector(".popup__button"),o=t?t.textContent:"Да";i(!0,t,o,"Удаление..."),H(L).then(()=>{q.remove(),q=null,L=null,p(f)}).catch(r=>{console.error("Ошибка при удалении карточки:",r)}).finally(()=>{i(!1,t,o,"Да")})});const Pe=document.querySelectorAll(".popup");Pe.forEach(e=>{te(e)});Promise.all([V(),ie()]).then(([e,t])=>{A=t._id,I.textContent=t.name,E.textContent=t.about,M.style.backgroundImage=`url(${t.avatar})`,e.forEach(o=>{z.append(J(o))})}).catch(e=>{console.error(e)});
